<head>
  <meta charset="UTF-8" />
  <title>Perth Initiated Devotee List</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
/* Sorting icons */
.sortable {
  cursor: pointer;
  position: relative;
  padding-right: 18px;
}

.sortable .sort-icon {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 10px;
  color: black;
  opacity: 0.8;
  font-weight: bold;
}

#country {
  max-width: 120px;
  width: 120px;
}
#dikshaGuru {
  max-width: 280px;
  width: 100%;
}


/* Narrower Country column */
#devoteeTable th:nth-child(16),
#devoteeTable td:nth-child(16) {
  max-width: 80px;
  width: 80px;
}
#devoteeTable th[data-field="dikshaGuru"],
#devoteeTable td:nth-child(??) {
  max-width: 220px;
  width: 220px;
}


body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background-image: url('https://iskconnewtown.com/wp-content/uploads/2024/02/nitai-gauranga-iskconnewtown-kolkata-6.jpeg');
  background-repeat: no-repeat;
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
}

header {
  background: rgba(0,0,0,0.7);
  color: #fff;
  padding: 15px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.view-switch button {
  padding: 10px 20px;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  font-weight: 600;
  background: #f6e58d;
  margin-left: 8px;
}

.view-switch button.active {
  background: #e17055;
  color: #fff;
}

main { padding: 25px; }

.card {
  background: rgba(255,255,255,0.92);
  border-radius: 14px;
  padding: 22px;
  max-width: 1100px;
  margin: 0 auto;
}

.card#adminView {
  max-width: 100%;
  width: 100%;
}

.hidden { display: none; }

.form-section-title {
  font-size: 18px;
  margin-top: 20px;
  margin-bottom: 8px;
  font-weight: 700;
  color: #e67e22;
}

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-bottom: 10px;
}

.form-group {
  flex: 1 1 260px;
  display: flex;
  flex-direction: column;
}

input, select {
  padding: 7px 9px;
  border-radius: 6px;
  border: 1px solid #b2bec3;
  background: #fffdf8;
}

.submit-row {
  margin-top: 20px;
  text-align: right;
}

.submit-row button {
  padding: 9px 18px;
  border-radius: 20px;
  border: none;
  background: #e17055;
  color: white;
  font-size: 14px;
  cursor: pointer;
  font-weight: 600;
  margin-left: 8px;
}

.error {
  color: red;
  font-size: 12px;
  margin-top: 3px;
}

.admin-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}

.admin-controls button {
  padding: 7px 14px;
  border-radius: 18px;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  background: #fab1a0;
  color: #2d3436;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
  font-size: 13px;
  table-layout: fixed;
}

th, td {
  padding: 10px 12px;
  border: 1px solid #dfe6e9;
  vertical-align: top;
  word-wrap: break-word;
  white-space: normal;
  overflow-wrap: break-word;
  max-width: 180px;
  min-width: 100px;
}

th {
  background: #e67e22;
  color: #fff;
}

.country-select {
  position: relative;
  width: 120px;
}

.country-select input {
  width: 100%;
  padding: 7px 9px;
  border-radius: 6px;
  border: 1px solid #b2bec3;
  background: #fffdf8;
  cursor: default;
}

.country-options {
  position: absolute;
  top: 38px;
  left: 0;
  width: 100%;
  background: white;
  border: 1px solid #ccc;
  border-radius: 6px;
  max-height: 180px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.country-option {
  padding: 6px 10px;
  cursor: pointer;
  display: flex;
  gap: 6px;
  align-items: center;
}

.flag {
  font-size: 18px;
}

.modal-backdrop,
.admin-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.modal,
.admin-modal {
  background: #fff;
  padding: 20px 24px;
  border-radius: 10px;
  max-width: 320px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.modal button,
.admin-modal button {
  margin-top: 12px;
  padding: 7px 16px;
  border-radius: 18px;
  border: none;
  background: #e17055;
  color: #fff;
  cursor: pointer;
  font-weight: 600;
}

.admin-modal input {
  width: 100%;
  margin-top: 8px;
  padding: 7px 9px;
  border-radius: 6px;
  border: 1px solid #b2bec3;
}

.disabled-field {
  background: #eee;
}

/* Edit modal */
.edit-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2100;
}
.edit-modal {
  background: #fff;
  padding: 16px 20px;
  border-radius: 10px;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
}
.edit-modal h3 {
  margin-top: 0;
}
.edit-row {
  display: flex;
  gap: 10px;
  margin-bottom: 8px;
}
.edit-row > div {
  flex: 1;
}
.edit-modal label {
  display: block;
  font-size: 12px;
  margin-bottom: 2px;
}
.edit-modal input, .edit-modal select {
  width: 100%;
  padding: 5px 7px;
  border-radius: 6px;
  border: 1px solid #b2bec3;
}
.edit-modal-buttons {
  margin-top: 10px;
  text-align: right;
}
.edit-modal-buttons button {
  margin-left: 8px;
  padding: 6px 14px;
  border-radius: 18px;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
}
.edit-save-btn {
  background: #27ae60;
  color: #fff;
}
.edit-cancel-btn {
  background: #777;
  color: #fff;
}
  </style>
</head>
<body>

<header>
  <h1>Perth Initiated Devotee List</h1>
  <div class="view-switch">
    <button id="adminViewBtn">Admin View</button>
    <button id="userViewBtn" class="active">User View</button>
  </div>
</header>

<main>

<div id="welcomeMessage" class="card" style="text-align:center; margin-bottom:20px;">
  <img src="iskcon-logo.png"
       alt="ISKCON Perth"
       style="display:block; margin:0 auto 10px; max-width:180px;">
  <h2 style="margin-bottom:0;">Welcome to ISKCON Perth</h2>
</div>

<!-- ===================== ADMIN VIEW ===================== -->
<div id="adminView" class="card hidden">
  <h2>Admin Dashboard</h2>

  <div class="admin-controls">
    <button id="deleteSelectedBtn">Delete Multiple</button>
    <button id="exportAllCsvBtn">Export to .csv</button>
    <button id="exportAllXlsxBtn">Export to .xlsx</button>
  </div>

  <input 
    type="text" 
    id="adminSearchInput" 
    placeholder="Search devotees..." 
    style="padding:8px; width:260px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;">

  <table id="devoteeTable">
    <thead>
      <tr>
        <th style="width:20px;"></th>          <!-- checkbox -->
        <th style="width:40px;">Edit</th>      <!-- edit button -->
        <th style="width:60px;">Delete</th>    <!-- delete button -->

        <th data-field="firstName" class="sortable">First Name <span class="sort-icon"></span></th>
        <th data-field="lastName" class="sortable">Last Name <span class="sort-icon"></span></th>
        <th data-field="fullName" class="sortable">Full Name as per passport <span class="sort-icon"></span></th>
        <th data-field="email" class="sortable">Email <span class="sort-icon"></span></th>
        <th data-field="gender" class="sortable">Gender <span class="sort-icon"></span></th>
        <th data-field="dob" class="sortable">DOB <span class="sort-icon"></span></th>

        <!-- REPLACED PASSPORT WITH DRIVING LICENCE -->
        <th data-field="drivingLicence" class="sortable">Driving Licence <span class="sort-icon"></span></th>

        <th data-field="mobile" class="sortable">Mobile <span class="sort-icon"></span></th>
        <th data-field="familyHead" class="sortable">Family Head <span class="sort-icon"></span></th>
        <th data-field="addrLine1" class="sortable">Addr1 <span class="sort-icon"></span></th>
        <th data-field="addrLine2" class="sortable">Addr2 <span class="sort-icon"></span></th>
        <th data-field="city" class="sortable">City <span class="sort-icon"></span></th>
        <th data-field="state" class="sortable">State <span class="sort-icon"></span></th>
        <th data-field="postcode" class="sortable">Postcode <span class="sort-icon"></span></th>
        <th data-field="country" class="sortable">Country <span class="sort-icon"></span></th>

        <th data-field="areInitiated" class="sortable">Are Initiated <span class="sort-icon"></span></th>
        <th data-field="initiatedName" class="sortable">Initiated Name <span class="sort-icon"></span></th>
        <th data-field="initiationStatus" class="sortable">Initiation Status <span class="sort-icon"></span></th>
        <th data-field="placeOfInitiation" class="sortable">Place of Initiation <span class="sort-icon"></span></th>
        <th data-field="initiationDate" class="sortable">Initiation Date <span class="sort-icon"></span></th>

        <th data-field="shikshaGuru" class="sortable">Siksha Guru / Mentor <span class="sort-icon"></span></th>
        <th data-field="dikshaGuru" class="sortable">Diksha Guru <span class="sort-icon"></span></th>

        <th data-field="submissionDate" class="sortable">Submission Date <span class="sort-icon"></span></th>
        <th data-field="lastUpdatedDate" class="sortable">Last Updated <span class="sort-icon"></span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="paginationControls" style="margin-top:15px; text-align:center; font-weight:600;"></div>
</div>

<!-- ===================== USER VIEW ===================== -->
<div id="userView" class="card">
  <h2>Dear Devotee, please fill the below details</h2>

  <form id="devoteeForm">

    <!-- PERSONAL DETAILS -->
    <div class="form-section-title">Personal Details</div>

    <div class="form-row">
      <div class="form-group">
        <label>First Name (as per passport) *</label>
        <input type="text" id="firstName">
        <div class="error" id="firstNameError"></div>
      </div>

      <div class="form-group">
        <label>Last Name (as per passport) *</label>
        <input type="text" id="lastName">
        <div class="error" id="lastNameError"></div>
      </div>

      <div class="form-group">
        <label>Full Name as per passport</label>
        <input type="text" id="fullName">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Email Address *</label>
        <input type="email" id="email">
        <div class="error" id="emailError"></div>
      </div>

      <div class="form-group">
        <label>Gender</label>
        <select id="gender">
          <option value="">Select</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Date of Birth *</label>
        <input type="date" id="dob">
        <div class="error" id="dobError"></div>
      </div>
    </div>

    <div class="form-row">

      <!-- REPLACED PASSPORT WITH DRIVING LICENCE -->
      <div class="form-group">
        <label>Driving Licence Number (optional)</label>
        <input type="text" id="drivingLicence">
      </div>

      <div class="form-group">
        <label>Mobile Number (Australia only) *</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="country-select">
            <input type="text" id="countryCodeInput" value="+61" readonly>
            <div class="country-options" id="countryOptions">
              <div class="country-option" data-code="+61">
                <span class="flag">ðŸ‡¦ðŸ‡º</span> +61 Australia
              </div>
            </div>
          </div>
          <input type="text" id="mobileNumber" placeholder="04xx xxx xxx" style="width:140px;">
        </div>
        <div class="error" id="mobileError"></div>
      </div>

    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="familyHead">
      <label for="familyHead">Are you family head?</label>
    </div>

    <!-- ADDRESS -->
    <div class="form-section-title">Current Address</div>

    <div class="form-row">
      <div class="form-group">
        <label>Address Line 1</label>
        <input type="text" id="addrLine1">
      </div>

      <div class="form-group">
        <label>Address Line 2</label>
        <input type="text" id="addrLine2">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>City</label>
        <input type="text" id="city">
      </div>

      <div class="form-group">
        <label>State</label>
        <input type="text" id="state">
      </div>

      <div class="form-group">
        <label>Postcode</label>
        <input type="text" id="postcode">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Country</label>
        <select id="country">
          <option value="Australia">ðŸ‡¦ðŸ‡º Australia</option>
        </select>
      </div>
    </div>

    <!-- INITIATION DETAILS -->
    <div class="form-section-title">Initiation Details</div>

    <div class="form-row">
      <div class="form-group">
        <label>Are you initiated?</label>
        <select id="areInitiated">
          <option value="">Select</option>
          <option>YES</option>
          <option>NO</option>
        </select>
      </div>

      <div class="form-group">
        <label>Initiated Name</label>
        <input type="text" id="initiatedName" class="init-field">
      </div>

      <div class="form-group">
        <label>Initiation Status</label>
        <select id="initiationStatus" class="init-field">
          <option value="">Select</option>
          <option>First</option>
          <option>Second</option>
          <option>No</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Place of Initiation</label>
        <input type="text" id="placeOfInitiation" class="init-field">
      </div>

      <div class="form-group">
        <label>Date of Initiation</label>
        <input type="date" id="initiationDate" class="init-field">
      </div>

      <div class="form-group">
        <label>Siksha Guru / Mentor (optional)</label>
        <input type="text" id="shikshaGuru">
      </div>
    </div>

<div class="form-group">
  <label>Diksha Guru Name</label>
  <input list="dikshaGuruList" id="dikshaGuru" placeholder="<Enter/Select your Guru Maharaj Name>" style="max-width:280px;">
  <datalist id="dikshaGuruList">
    <option value="HH Jayapataka Swami Maharaj">
    <option value="HH Radhanath Swami Maharaj">
    <option value="HH Romapada Swami Maharaj">
    <option value="HH Gopal Krishna Goswami Maharaj">
    <option value="HH Bhakti Vikasa Swami Maharaj">
  </datalist>
</div>


    <div class="submit-row">
      <button type="submit">Submit</button>
      <button type="button" id="resetBtn" style="background:#777;">Reset</button>
    </div>

  </form>
</div>
<!-- SUCCESS MODAL -->
<div id="successModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Submitted successfully</h3>
    <p>Thank you for entering your details.</p>
    <button id="successCloseBtn">Close</button>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="adminModalBackdrop" class="admin-modal-backdrop">
  <div class="admin-modal">
    <h3>Admin Login</h3>
    <input type="password" id="adminPasswordInput" placeholder="Enter password">
    <div class="error" id="adminPasswordError"></div>
    <button id="adminLoginBtn">Login</button>
  </div>
</div>

<!-- DUPLICATE CONFIRM MODAL -->
<div id="duplicateModalBackdrop" class="admin-modal-backdrop">
  <div class="admin-modal">
    <h3>Duplicate Record Found</h3>
    <p>Thereâ€™s already a record existing with this email or mobile number.<br>Do you want to update that record?</p>
    <button id="duplicateYesBtn">Yes</button>
    <button id="duplicateNoBtn" style="background:#777;">No</button>
  </div>
</div>

<!-- DELETE CONFIRM MODAL -->
<div id="deleteModalBackdrop" class="admin-modal-backdrop">
  <div class="admin-modal">
    <h3>Confirm Delete</h3>
    <p id="deleteModalText">Are you sure you want to delete these records?</p>
    <button id="deleteYesBtn">Yes</button>
    <button id="deleteNoBtn" style="background:#777;">No</button>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="editModalBackdrop" class="edit-modal-backdrop">
  <div class="edit-modal">
    <h3>Edit Devotee</h3>

    <form id="editForm">

      <div class="edit-row">
        <div>
          <label>First Name</label>
          <input type="text" id="edit_firstName">
        </div>
        <div>
          <label>Last Name</label>
          <input type="text" id="edit_lastName">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Full Name as per passport</label>
          <input type="text" id="edit_fullName">
        </div>
        <div>
          <label>Email</label>
          <input type="email" id="edit_email">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Gender</label>
          <select id="edit_gender">
            <option value="">Select</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label>DOB</label>
          <input type="date" id="edit_dob">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <!-- REPLACED PASSPORT WITH DRIVING LICENCE -->
          <label>Driving Licence Number (optional)</label>
          <input type="text" id="edit_drivingLicence">
        </div>
        <div>
          <label>Mobile</label>
          <input type="text" id="edit_mobile">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <div style="display:flex; flex-direction:column; align-items:flex-start;">
            <label for="edit_familyHead">Family Head</label>
            <input type="checkbox" id="edit_familyHead" style="margin-top:4px;">
          </div>
        </div>
        <div>
          <label>Country</label>
          <input type="text" id="edit_country">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Address Line 1</label>
          <input type="text" id="edit_addrLine1">
        </div>
        <div>
          <label>Address Line 2</label>
          <input type="text" id="edit_addrLine2">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>City</label>
          <input type="text" id="edit_city">
        </div>
        <div>
          <label>State</label>
          <input type="text" id="edit_state">
        </div>
        <div>
          <label>Postcode</label>
          <input type="text" id="edit_postcode">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Are Initiated</label>
          <select id="edit_areInitiated">
            <option value="">Select</option>
            <option>YES</option>
            <option>NO</option>
          </select>
        </div>
        <div>
          <label>Initiated Name</label>
          <input type="text" id="edit_initiatedName">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Initiation Status</label>
          <input type="text" id="edit_initiationStatus">
        </div>
        <div>
          <label>Place of Initiation</label>
          <input type="text" id="edit_placeOfInitiation">
        </div>
      </div>

      <div class="edit-row">
        <div>
          <label>Initiation Date</label>
          <input type="date" id="edit_initiationDate">
        </div>
        <div>
          <label>Siksha Guru / Mentor</label>
          <input type="text" id="edit_shikshaGuru">
        </div>
        <div>
          <label>Diksha Guru</label>
          <input list="editDikshaGuruList" id="edit_dikshaGuru" style="max-width:300px;">
<datalist id="editDikshaGuruList">
  <option value="HH Jayapataka Swami Maharaj">
  <option value="HH Radhanath Swami Maharaj">
  <option value="HH Romapada Swami Maharaj">
  <option value="HH Gopal Krishna Goswami Maharaj">
  <option value="HH Bhakti Vikasa Swami Maharaj">
  <option value="<Enter/Select your Guru Maharaj Name>">
</datalist>

        </div>
      </div>

      <div class="edit-modal-buttons">
        <button type="button" class="edit-cancel-btn" id="editCancelBtn">Cancel</button>
        <button type="submit" class="edit-save-btn">Save</button>
      </div>

    </form>
  </div>
</div>
<script>
/* ============================================================
   FIREBASE INITIALIZATION
============================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyDxJY7_VirTqoXMYbjjFzsHaAz-KSbQEj8",
  authDomain: "bhakti-vriksha-2e295.firebaseapp.com",
  databaseURL: "https://bhakti-vriksha-2e295-default-rtdb.firebaseio.com",
  projectId: "bhakti-vriksha-2e295",
  storageBucket: "bhakti-vriksha-2e295.appspot.com",
  messagingSenderId: "159402779568",
  appId: "1:159402779568:web:dc0c4a39a0c51d08dcac75",
  measurementId: "G-5LKYY6YZBC"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================================================
   UNIFIED APPLICATION LOGIC
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
/* Guru Maharaj List */
const guruList = [
  "HH Jayapataka Swami Maharaj",
  "HH Radhanath Swami Maharaj",
  "HH Romapada Swami Maharaj",
  "HH Gopal Krishna Goswami Maharaj",
  "HH Bhakti Vikasa Swami Maharaj"
];
/* Sentence case: "I live in India" */
function toSentenceCase(str) {
  if (!str) return "";
  str = str.toLowerCase();
  return str.charAt(0).toUpperCase() + str.slice(1);
}

/* Title case for Guru names */
function toTitleCase(str) {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}



  /* ------------------------------------------------------------
     ELEMENT REFERENCES
  ------------------------------------------------------------ */
  const form = document.getElementById("devoteeForm");
  const resetBtn = document.getElementById("resetBtn");
  const successModalBackdrop = document.getElementById("successModalBackdrop");
  const successCloseBtn = document.getElementById("successCloseBtn");

  const adminBtn = document.getElementById("adminViewBtn");
  const userBtn = document.getElementById("userViewBtn");
  const adminView = document.getElementById("adminView");
  const userView = document.getElementById("userView");
  const welcomeMessage = document.getElementById("welcomeMessage");

  const adminModalBackdrop = document.getElementById("adminModalBackdrop");
  const adminPasswordInput = document.getElementById("adminPasswordInput");
  const adminPasswordError = document.getElementById("adminPasswordError");
  const adminLoginBtn = document.getElementById("adminLoginBtn");

  const deleteModalBackdrop = document.getElementById("deleteModalBackdrop");
  const deleteYesBtn = document.getElementById("deleteYesBtn");
  const deleteNoBtn = document.getElementById("deleteNoBtn");

  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  const exportAllCsvBtn = document.getElementById("exportAllCsvBtn");
  const exportAllXlsxBtn = document.getElementById("exportAllXlsxBtn");

  const countryCodeInput = document.getElementById("countryCodeInput");
  const countryOptions = document.getElementById("countryOptions");

  const ADMIN_PASSWORD = "Kalamunda";

  let devotees = [];
  let devoteesKeys = [];
  let currentEditKey = null;

  // Pagination
  let currentPage = 1;
  const pageSize = 50;


  /* ------------------------------------------------------------
     COUNTRY CODE DROPDOWN (Australia only)
  ------------------------------------------------------------ */
  if (countryCodeInput && countryOptions) {
    countryCodeInput.onclick = () => {
      countryOptions.style.display = "block";
    };

    document.addEventListener("click", (e) => {
      if (!countryCodeInput.contains(e.target) && !countryOptions.contains(e.target)) {
        countryOptions.style.display = "none";
      }
    });

    countryOptions.querySelectorAll(".country-option").forEach(opt => {
      opt.onclick = () => {
        countryCodeInput.value = opt.dataset.code;
        countryOptions.style.display = "none";
      };
    });
  }

  /* ------------------------------------------------------------
     MOBILE VALIDATION HELPERS
  ------------------------------------------------------------ */
  function formatAustralianMobile(num) {
    let digits = num.replace(/\D/g, "");
    if (digits.length === 9 && digits.startsWith("4")) digits = "0" + digits;
    if (!digits.startsWith("04")) return null;
    if (digits.length !== 10) return null;
    return digits.replace(/(\d{4})(\d{3})(\d{3})/, "$1 $2 $3");
  }

  // Strict normalizer for admin edit: returns "+61 4xx xxx xxx" or null
  function formatMobile(input) {
    let cleaned = input.replace(/\D/g, "");

    if (cleaned.startsWith("04") && cleaned.length === 10) {
      cleaned = "614" + cleaned.slice(2);
    } else if (cleaned.startsWith("4") && cleaned.length === 9) {
      cleaned = "614" + cleaned;
    } else if (cleaned.startsWith("614") && cleaned.length === 11) {
      // already correct
    } else {
      return null; // invalid
    }

    return `+61 ${cleaned.slice(2,5)} ${cleaned.slice(5,8)} ${cleaned.slice(8)}`;
  }

  /* ------------------------------------------------------------
     INITIATION FIELDS ENABLE/DISABLE (USER FORM)
  ------------------------------------------------------------ */
  const areInitiatedEl = document.getElementById("areInitiated");
  const initFields = document.querySelectorAll(".init-field");
  const dikshaGuruEl = document.getElementById("dikshaGuru");

  function updateInitiationFields() {
    const val = (areInitiatedEl.value || "").toUpperCase();
    const disabled = (val === "NO");

    initFields.forEach(el => {
      el.disabled = disabled;
      if (disabled) {
        el.classList.add("disabled-field");
        el.value = "";
      } else {
        el.classList.remove("disabled-field");
      }
    });

    if (val === "NO") {
      dikshaGuruEl.disabled = true;
      dikshaGuruEl.classList.add("disabled-field");
      dikshaGuruEl.value = "";
    } else {
      dikshaGuruEl.disabled = false;
      dikshaGuruEl.classList.remove("disabled-field");
    }
  }

  areInitiatedEl.addEventListener("change", updateInitiationFields);
  updateInitiationFields();


  /* ------------------------------------------------------------
     DUPLICATE CHECK (Email + Mobile ONLY)
  ------------------------------------------------------------ */
  async function findDuplicateKey(emailLower, normalizedMobile) {
    const snap = await db.ref("devotees").once("value");
    let foundKey = null;

    snap.forEach(child => {
      const v = child.val() || {};
      const e = (v.email || "").toLowerCase().trim();
      const m = (v.mobile || "").trim();

      if (e === emailLower || m === normalizedMobile) {
        foundKey = child.key;
      }
    });

    return foundKey;
  }

  /* ------------------------------------------------------------
     FORM SUBMISSION (USER)
  ------------------------------------------------------------ */
  form.onsubmit = async (e) => {
    e.preventDefault();

    let valid = true;

    const required = [
      ["firstName", "First name is required"],
      ["lastName", "Last name is required"],
      ["dob", "Date of birth is required"],
      ["email", "Email is required"]
    ];

    required.forEach(([id, msg]) => {
      const input = document.getElementById(id);
      const error = document.getElementById(id + "Error");
      if (!input.value.trim()) {
        if (error) error.textContent = msg;
        valid = false;
      } else {
        if (error) error.textContent = "";
      }
    });

    /* MOBILE VALIDATION */
    const mobileNumberEl = document.getElementById("mobileNumber");
    const mobileNumber = mobileNumberEl.value.trim();
    const mobileError = document.getElementById("mobileError");
    const countryCode = countryCodeInput.value.trim();

    if (!countryCode || !mobileNumber) {
      mobileError.textContent = "Mobile number with country code is required";
      valid = false;
    } else {
      const formatted = formatAustralianMobile(mobileNumber);
      if (!formatted) {
        mobileError.textContent = "Australian mobile must be 10 digits and start with 04";
        valid = false;
      } else {
        const normalized = "+61 " + formatted.slice(1);
        mobileNumberEl.value = formatted;
        mobileError.textContent = "";
        mobileNumberEl.dataset.normalizedMobile = normalized;
      }
    }

    if (!valid) return;

    /* FULL NAME AUTO-GENERATION */
    const first = document.getElementById("firstName").value.trim();
    const last = document.getElementById("lastName").value.trim();
    const fullNameInput = document.getElementById("fullName").value.trim();
    const fullName = fullNameInput || `${first} ${last}`.trim();

    const now = Date.now();
    const emailRaw = document.getElementById("email").value.trim();
    const emailLower = emailRaw.toLowerCase();
    const normalizedMobile = mobileNumberEl.dataset.normalizedMobile;

    const data = {
      firstName: first,
      lastName: last,
      fullName,
      email: emailRaw,
      gender: document.getElementById("gender").value,
      dob: document.getElementById("dob").value,

      /* NEW FIELD */
      drivingLicence: document.getElementById("drivingLicence").value.trim(),

      mobile: normalizedMobile,
      familyHead: document.getElementById("familyHead").checked ? "Yes" : "No",
      addrLine1: document.getElementById("addrLine1").value.trim(),
      addrLine2: document.getElementById("addrLine2").value.trim(),
      city: document.getElementById("city").value.trim(),
      state: document.getElementById("state").value.trim(),
      postcode: document.getElementById("postcode").value.trim(),
      country: document.getElementById("country").value,

      areInitiated: document.getElementById("areInitiated").value,
      initiatedName: document.getElementById("initiatedName").value.trim(),
      initiationStatus: document.getElementById("initiationStatus").value,
      placeOfInitiation: document.getElementById("placeOfInitiation").value.trim(),
      initiationDate: document.getElementById("initiationDate").value,
      shikshaGuru: document.getElementById("shikshaGuru").value.trim(),
      dikshaGuru: document.getElementById("dikshaGuru").value.trim(),

      submissionDate: now,
      lastUpdatedDate: now
    };

    try {
      const dupKey = await findDuplicateKey(emailLower, normalizedMobile);

      if (dupKey) {
        const overwrite = await showDuplicateModal();
        if (!overwrite) return;
        await db.ref("devotees/" + dupKey).update(data);
      } else {
        const ref = db.ref("devotees").push();
        await ref.set(data);
      }

      form.reset();
      countryCodeInput.value = "+61";
      document.querySelectorAll(".error").forEach(e => e.textContent = "");
      updateInitiationFields();
      successModalBackdrop.style.display = "flex";

    } catch (err) {
      alert("Error submitting details. Please try again.");
      console.error(err);
    }
  };

  /* RESET BUTTON */
  resetBtn.onclick = () => {
    form.reset();
    countryCodeInput.value = "+61";
    document.querySelectorAll(".error").forEach(e => e.textContent = "");
    updateInitiationFields();
  };

  successCloseBtn.onclick = () => {
    successModalBackdrop.style.display = "none";
  };

  /* ------------------------------------------------------------
     ADMIN LOGIN
  ------------------------------------------------------------ */
  function showAdminModal() {
    adminPasswordInput.value = "";
    adminPasswordError.textContent = "";
    adminModalBackdrop.style.display = "flex";
    adminPasswordInput.focus();
  }

  function hideAdminModal() {
    adminModalBackdrop.style.display = "none";
  }

  adminBtn.onclick = () => showAdminModal();

  adminLoginBtn.onclick = () => {
    if (adminPasswordInput.value === ADMIN_PASSWORD) {
      hideAdminModal();
      adminView.classList.remove("hidden");
      userView.classList.add("hidden");
      if (welcomeMessage) welcomeMessage.style.display = "none";
      loadFromDatabase();
    } else {
      adminPasswordError.textContent = "Incorrect password.";
    }
  };

  /* ------------------------------------------------------------
     DELETE MODAL
  ------------------------------------------------------------ */
  function showDeleteModal(names = []) {
    return new Promise(resolve => {
      const textEl = document.getElementById("deleteModalText");

      if (names.length === 0) {
        textEl.textContent = "Are you sure you want to delete these records?";
      } else if (names.length === 1) {
        textEl.textContent = `Are you sure you want to delete ${names[0]}?`;
      } else {
        const joined = names.join(", ");
        textEl.textContent = `Are you sure you want to delete these ${names.length} records of ${joined}?`;
      }

      deleteModalBackdrop.style.display = "flex";

      deleteYesBtn.onclick = () => {
        deleteModalBackdrop.style.display = "none";
        resolve(true);
      };

      deleteNoBtn.onclick = () => {
        deleteModalBackdrop.style.display = "none";
        resolve(false);
      };
    });
  }

  /* ------------------------------------------------------------
     DUPLICATE MODAL
  ------------------------------------------------------------ */
  const duplicateModalBackdrop = document.getElementById("duplicateModalBackdrop");
  const duplicateYesBtn = document.getElementById("duplicateYesBtn");
  const duplicateNoBtn = document.getElementById("duplicateNoBtn");

  function showDuplicateModal() {
    return new Promise(resolve => {
      duplicateModalBackdrop.style.display = "flex";

      duplicateYesBtn.onclick = () => {
        duplicateModalBackdrop.style.display = "none";
        resolve(true);
      };

      duplicateNoBtn.onclick = () => {
        duplicateModalBackdrop.style.display = "none";
        resolve(false);
      };
    });
  }

  userBtn.onclick = () => {
    adminView.classList.add("hidden");
    userView.classList.remove("hidden");
    if (welcomeMessage) welcomeMessage.style.display = "none";
  };
  /* ------------------------------------------------------------
     LOAD DATA FOR ADMIN TABLE
  ------------------------------------------------------------ */
  function loadFromDatabase() {
    db.ref("devotees").once("value", (snapshot) => {
      devotees = [];
      devoteesKeys = [];
      snapshot.forEach(child => {
        devoteesKeys.push(child.key);
        devotees.push(child.val());
      });
      currentPage = 1;
      renderWithPagination();
      updateSortIcons();
    });
  }

  /* ------------------------------------------------------------
     FORMAT DOB & TIMESTAMP
  ------------------------------------------------------------ */
  function formatDOB(dateStr) {
    if (!dateStr) return "";
    const parts = dateStr.split("-");
    if (parts.length !== 3) return dateStr;
    const [yyyy, mm, dd] = parts;
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${dd}-${months[parseInt(mm)-1]}-${yyyy}`;
  }

  function formatTimestamp(ts) {
    if (!ts) return "";
    const d = new Date(ts);
    const dd = String(d.getDate()).padStart(2,"0");
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const mmm = months[d.getMonth()];
    const yyyy = d.getFullYear();
    let hours = d.getHours();
    const minutes = String(d.getMinutes()).padStart(2,"0");
    const ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12 || 12;
    return `${dd}-${mmm}-${yyyy} ${hours}:${minutes} ${ampm}`;
  }

  /* ------------------------------------------------------------
     RENDER ADMIN TABLE
  ------------------------------------------------------------ */
  function renderTable(list = devotees, page = 1) {
    const tbody = document.querySelector("#devoteeTable tbody");
    tbody.innerHTML = "";

    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageItems = list.slice(start, end);

    pageItems.forEach((d, indexOnPage) => {
      const globalIndex = start + indexOnPage;
      const row = document.createElement("tr");

      // Checkbox
      const checkboxTd = document.createElement("td");
      checkboxTd.style.textAlign = "center";
      checkboxTd.innerHTML = `<input type="checkbox" class="row-select" data-index="${globalIndex}">`;
      row.appendChild(checkboxTd);

      // Edit button
      const editTd = document.createElement("td");
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.style.padding = "4px 8px";
      editBtn.style.borderRadius = "12px";
      editBtn.style.border = "none";
      editBtn.style.background = "#74b9ff";
      editBtn.style.color = "#fff";
      editBtn.style.cursor = "pointer";
      editBtn.onclick = () => openEditModal(globalIndex);
      editTd.appendChild(editBtn);
      row.appendChild(editTd);

      // Delete button
      const deleteTd = document.createElement("td");
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.style.padding = "4px 8px";
      deleteBtn.style.borderRadius = "12px";
      deleteBtn.style.border = "none";
      deleteBtn.style.background = "#d63031";
      deleteBtn.style.color = "#fff";
      deleteBtn.style.cursor = "pointer";
      deleteBtn.onclick = async () => {
        const name = d.fullName || "this devotee";
        const confirmed = await showDeleteModal([name]);
        if (!confirmed) return;
        const key = devoteesKeys[globalIndex];
        if (key) db.ref("devotees/" + key).remove().then(() => loadFromDatabase());
      };
      deleteTd.appendChild(deleteBtn);
      row.appendChild(deleteTd);

      // Data cells (Driving Licence included)
      const cells = [
        d.firstName || "",
        d.lastName || "",
        d.fullName || "",
        d.email || "",
        d.gender || "",
        formatDOB(d.dob || ""),
        d.drivingLicence || "",
        d.mobile || "",
        d.familyHead || "",
toSentenceCase(d.addrLine1 || ""), 
toSentenceCase(d.addrLine2 || ""), 
toSentenceCase(d.city || ""), 
toSentenceCase(d.state || ""),
        d.postcode || "",
        d.country || "",
        d.areInitiated || "",
        d.initiatedName || "",
        d.initiationStatus || "",
toSentenceCase(d.placeOfInitiation || ""),
        formatDOB(d.initiationDate || ""),
toTitleCase(d.shikshaGuru || ""),
(d.dikshaGuru || "").toUpperCase(),

        formatTimestamp(d.submissionDate),
        formatTimestamp(d.lastUpdatedDate)
      ];

      cells.forEach(val => {
        const td = document.createElement("td");
        td.textContent = val;
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
  }

  function renderWithPagination(list = devotees) {
    renderTable(list, currentPage);
    buildPaginationControls(list);
  }

  function buildPaginationControls(list = devotees) {
    const totalItems = list.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
    const container = document.getElementById("paginationControls");
    if (!container) return;

    if (currentPage > totalPages) currentPage = totalPages;

    container.innerHTML = "";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "Â« Prev";
    prevBtn.disabled = (currentPage === 1);
    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderWithPagination(list);
        updateSortIcons();
      }
    };

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Next Â»";
    nextBtn.disabled = (currentPage === totalPages);
    nextBtn.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderWithPagination(list);
        updateSortIcons();
      }
    };

    const infoSpan = document.createElement("span");
    infoSpan.textContent = `Page ${currentPage} of ${totalPages}`;

    [prevBtn, infoSpan, nextBtn].forEach(el => {
      el.style.padding = "5px 10px";
      el.style.borderRadius = "14px";
      el.style.border = "none";
      el.style.cursor = "pointer";
      el.style.fontSize = "13px";
      el.style.fontWeight = "600";
    });

    prevBtn.style.background = "#fab1a0";
    nextBtn.style.background = "#fab1a0";
    infoSpan.style.background = "transparent";

    container.appendChild(prevBtn);
    container.appendChild(infoSpan);
    container.appendChild(nextBtn);
  }

  /* ------------------------------------------------------------
     SEARCH + SORT
  ------------------------------------------------------------ */
  let currentSortField = null;
  let currentSortDirection = 1;

  document.getElementById("adminSearchInput").addEventListener("input", function () {
    const q = this.value.toLowerCase();
    const filtered = devotees.filter(d =>
      Object.values(d).some(v => String(v || "").toLowerCase().includes(q))
    );
    currentPage = 1;
    renderWithPagination(filtered);
  });

  document.querySelectorAll(".sortable").forEach(th => {
    th.addEventListener("click", () => {
      const field = th.dataset.field;

      if (currentSortField === field) {
        currentSortDirection *= -1;
      } else {
        currentSortField = field;
        currentSortDirection = 1;
      }

      devotees.sort((a, b) => {
        let A = a[field] || "";
        let B = b[field] || "";

        if (["dob","initiationDate","submissionDate","lastUpdatedDate"].includes(field)) {
          return (new Date(A) - new Date(B)) * currentSortDirection;
        }

        if (field === "postcode") {
          return (parseInt(A) - parseInt(B)) * currentSortDirection;
        }

        return A.toString().localeCompare(B.toString()) * currentSortDirection;
      });

      currentPage = 1;
      renderWithPagination();
      updateSortIcons();
    });
  });

  function updateSortIcons() {
    document.querySelectorAll(".sortable").forEach(th => {
      const icon = th.querySelector(".sort-icon");
      const field = th.dataset.field;
      if (!icon) return;
      if (field !== currentSortField) {
        icon.textContent = "";
      } else {
        icon.textContent = currentSortDirection === 1 ? "â–²" : "â–¼";
      }
    });
  }

  /* ------------------------------------------------------------
     DELETE SELECTED
  ------------------------------------------------------------ */
  deleteSelectedBtn.onclick = async () => {
    const checkboxes = document.querySelectorAll(".row-select:checked");
    const indexes = [...checkboxes].map(cb => parseInt(cb.dataset.index));

    if (indexes.length === 0) {
      alert("Please select at least one record to delete.");
      return;
    }

    const names = indexes.map(i => devotees[i].fullName || "this devotee");
    const confirmed = await showDeleteModal(names);
    if (!confirmed) return;

    const toDelete = indexes.map(i => devoteesKeys[i]).filter(k => k);
    toDelete.forEach(key => db.ref("devotees/" + key).remove());

    setTimeout(() => loadFromDatabase(), 500);
  };

  /* ------------------------------------------------------------
     EDIT MODAL LOGIC
  ------------------------------------------------------------ */
  const editModalBackdrop = document.getElementById("editModalBackdrop");
  const editForm = document.getElementById("editForm");
  const editCancelBtn = document.getElementById("editCancelBtn");

  function openEditModal(index) {
    const d = devotees[index];
    currentEditKey = devoteesKeys[index];

    document.getElementById("edit_firstName").value = d.firstName || "";
    document.getElementById("edit_lastName").value = d.lastName || "";
    document.getElementById("edit_fullName").value = d.fullName || "";
    document.getElementById("edit_email").value = d.email || "";
    document.getElementById("edit_gender").value = d.gender || "";
    document.getElementById("edit_dob").value = d.dob || "";

    /* NEW FIELD */
    document.getElementById("edit_drivingLicence").value = d.drivingLicence || "";

    document.getElementById("edit_mobile").value = d.mobile || "";
    document.getElementById("edit_familyHead").checked = (d.familyHead === "Yes");
    document.getElementById("edit_country").value = d.country || "";
    document.getElementById("edit_addrLine1").value = d.addrLine1 || "";
    document.getElementById("edit_addrLine2").value = d.addrLine2 || "";
    document.getElementById("edit_city").value = d.city || "";
    document.getElementById("edit_state").value = d.state || "";
    document.getElementById("edit_postcode").value = d.postcode || "";
    document.getElementById("edit_areInitiated").value = d.areInitiated || "";
    document.getElementById("edit_initiatedName").value = d.initiatedName || "";
    document.getElementById("edit_initiationStatus").value = d.initiationStatus || "";
    document.getElementById("edit_placeOfInitiation").value = d.placeOfInitiation || "";
    document.getElementById("edit_initiationDate").value = d.initiationDate || "";
    document.getElementById("edit_shikshaGuru").value = d.shikshaGuru || "";
    document.getElementById("edit_dikshaGuru").value =
  guruList.includes(d.dikshaGuru)
    ? d.dikshaGuru
    : toTitleCase(d.dikshaGuru || "");


    updateAdminInitiationFields();
    editModalBackdrop.style.display = "flex";
  }

  /* ------------------------------------------------------------
     ADMIN INITIATION FIELD ENABLE/DISABLE
  ------------------------------------------------------------ */
  function updateAdminInitiationFields() {
    const val = (document.getElementById("edit_areInitiated").value || "").toUpperCase();
    const disabled = (val === "NO");

    const fields = [
      "edit_initiatedName",
      "edit_initiationStatus",
      "edit_placeOfInitiation",
      "edit_initiationDate",
      "edit_dikshaGuru"
    ];

    fields.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = disabled;
      if (disabled) {
        el.classList.add("disabled-field");
        el.value = "";
      } else {
        el.classList.remove("disabled-field");
      }
    });
  }

  document.getElementById("edit_areInitiated")
    .addEventListener("change", updateAdminInitiationFields);

  editCancelBtn.onclick = () => {
    editModalBackdrop.style.display = "none";
    currentEditKey = null;
  };

  /* ------------------------------------------------------------
     EDIT FORM SUBMIT (Email + Mobile duplicate check)
  ------------------------------------------------------------ */
  editForm.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!currentEditKey) return;

    const emailRaw = document.getElementById("edit_email").value.trim();
    const emailLower = emailRaw.toLowerCase();
    const mobileInput = document.getElementById("edit_mobile").value.trim();
    const mobileFormatted = formatMobile(mobileInput);

    if (!emailRaw || !mobileFormatted) {
      alert("Email and a valid Australian mobile are required.");
      return;
    }

    const duplicateKey = devoteesKeys.find((key, i) => {
      const d = devotees[i];
      const e = (d.email || "").toLowerCase().trim();
      const m = (d.mobile || "").trim();
      return key !== currentEditKey && (e === emailLower || m === mobileFormatted);
    });

    if (duplicateKey) {
      const confirmUpdate = confirm("Another devotee with this email or mobile exists. Overwrite that record instead?");
      if (!confirmUpdate) return;
      currentEditKey = duplicateKey;
    }

    const updated = {
      firstName: document.getElementById("edit_firstName").value.trim(),
      lastName: document.getElementById("edit_lastName").value.trim(),
      fullName: document.getElementById("edit_fullName").value.trim(),
      email: emailRaw,
      gender: document.getElementById("edit_gender").value.trim(),
      dob: document.getElementById("edit_dob").value,

      /* NEW FIELD */
      drivingLicence: document.getElementById("edit_drivingLicence").value.trim(),

      mobile: mobileFormatted,
      familyHead: document.getElementById("edit_familyHead").checked ? "Yes" : "No",
      country: document.getElementById("edit_country").value.trim(),
addrLine1: toSentenceCase(document.getElementById("edit_addrLine1").value.trim()), 
addrLine2: toSentenceCase(document.getElementById("edit_addrLine2").value.trim()), 
city: toSentenceCase(document.getElementById("edit_city").value.trim()), 
state: toSentenceCase(document.getElementById("edit_state").value.trim()),
      postcode: document.getElementById("edit_postcode").value.trim(),
      areInitiated: document.getElementById("edit_areInitiated").value.trim(),
initiatedName: toSentenceCase(document.getElementById("edit_initiatedName").value.trim()),
      initiationStatus: document.getElementById("edit_initiationStatus").value.trim(),
placeOfInitiation: toSentenceCase(document.getElementById("edit_placeOfInitiation").value.trim()),
      initiationDate: document.getElementById("edit_initiationDate").value,
shikshaGuru: toTitleCase(document.getElementById("edit_shikshaGuru").value.trim()),
      dikshaGuru: document.getElementById("edit_dikshaGuru").value.trim().toUpperCase(),
      lastUpdatedDate: Date.now()
    };

    db.ref("devotees/" + currentEditKey).update(updated)
      .then(() => {
        editModalBackdrop.style.display = "none";
        currentEditKey = null;
        loadFromDatabase();
      })
      .catch(err => console.error(err));
  });

  /* ------------------------------------------------------------
     EXPORT FUNCTIONS
  ------------------------------------------------------------ */
  const exportFields = [
    "firstName", "lastName", "fullName", "email", "gender", "dob",
    "drivingLicence", "mobile", "familyHead",
    "addrLine1", "addrLine2", "city", "state", "postcode", "country",
    "areInitiated", "initiatedName", "initiationStatus", "placeOfInitiation",
    "initiationDate", "shikshaGuru", "dikshaGuru",
    "submissionDate", "lastUpdatedDate"
  ];

  function exportCSV(rows) {
    const header = exportFields.join(",");
    const csvRows = rows.map(r => {
      const obj = {};
      exportFields.forEach(f => {
        if (f === "dob" || f === "initiationDate") {
          obj[f] = formatDOB(r[f] || "");
        } else if (f === "submissionDate" || f === "lastUpdatedDate") {
          obj[f] = formatTimestamp(r[f]);
        } else {
          obj[f] = r[f] || "";
        }
      });
      return exportFields.map(f => `"${String(obj[f]).replace(/"/g,'""')}"`).join(",");
    });

    const csv = [header, ...csvRows].join("\n");
    const blob = new Blob([csv], { type:"text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "devotees.csv";
    a.click();
  }

  function exportExcel(rows) {
    const formatted = rows.map(r => {
      const obj = {};
      exportFields.forEach(f => {
        if (f === "dob" || f === "initiationDate") {
          obj[f] = formatDOB(r[f] || "");
        } else if (f === "submissionDate" || f === "lastUpdatedDate") {
          obj[f] = formatTimestamp(r[f]);
        } else {
          obj[f] = r[f] || "";
        }
      });
      return obj;
    });

    const ws = XLSX.utils.json_to_sheet(formatted, { header: exportFields });
    const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Devotees");
XLSX.writeFile(wb, "devotees.xlsx");
}

/* ------------------------------------------------------------
   EXPORT BUTTONS
------------------------------------------------------------ */
exportAllCsvBtn.onclick = () => exportCSV(devotees);
exportAllXlsxBtn.onclick = () => exportExcel(devotees);

});
</script>
</body>
</html>

